#!/usr/bin/env bash
# Copyright (C) oxidio. See LICENSE file for license details.

function main() {
    local base=${PWD}
    local command=${1-install}; shift
    [[ -f ${base}/.env ]] && . ${base}/.env

    echo "remove run directories 'rm -rf ${base}/{source,var}'"
    rm -rf ${base}/{source,var}

    echo "${command} '$@' composer packages"
    composer ${command} --no-plugins $@
    composer install $@

    echo "link resources in public directory"
    declare -A links=(
        ['out/downloads']='downloads'
        ['out/pictures/master']='pictures/master'
        ['out/pictures/media']='pictures/media'
        ['out/pictures/promo']='pictures/promo'
        ['out/pictures/vendor']='pictures/vendor'
        ['migration/project_data']='migration'
    )

    for link in "${!links[@]}"; do
        linkResource ${link} ${links[$link]}
    done

    [[ -z ${DB_STATE} ]] || rm -rf ${base}/source/Setup

    cat <<EOF > ${base}/source/config.inc.php
<?php
/**
 * Copyright (C) oxidio. See LICENSE file for license details.
 */

call_user_func(function () {
    require __DIR__ . '/../vendor/autoload.php';
    require __DIR__ . '/config.inc.php.dist';
    /** @var OxidEsales\EshopCommunity\Core\Config|BootstrapConfigFileReader \$this */
    class_exists(Oxidio\Bootstrap::class) && Oxidio\Bootstrap::bootstrap(\$this);
});

EOF
    [[ -z ${DB_STATE} ]] || chmod 444 ${base}/source/config.inc.php
    return 0;
}

function linkResource() {
    local base=${PWD} dst=${base}/source/${1} link=${SHOP_RESOURCES-resources/}${2}

    if [[ -e ${base}/${link} ]]; then
        local rel=${1//[^\/]}
        rel=$(printf '../%.0s' $(seq 0 ${#rel}))
		mkdir -p ${dst} 2>/dev/null
		rm -rf ${dst}
		ln -sf ${rel}${link} ${dst}
        echo "${dst}  ->  ${rel}${link}"
    fi
}

main $@
