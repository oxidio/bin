#!/usr/bin/env bash
# Copyright (C) oxidio. See LICENSE file for license details.
# shellcheck source=.

function main() {
    local base=${PWD}
    [[ -f "$base"/.env ]] && . "$base"/.env
    [[ -x ${base}/vendor/bin/oxidio-install ]] || composer install --no-plugins --no-scripts "$@"
    rm -rf "$base/source" "$base/var"

    composer install "$@"

    cat <<EOF > "$base/source/config.inc.php"
<?php
/**
 * Copyright (C) oxidio. See LICENSE file for license details.
 */

call_user_func(function () {
    require __DIR__ . '/../vendor/autoload.php';
    require __DIR__ . '/config.inc.php.dist';
    /** @var OxidEsales\EshopCommunity\Core\Config|BootstrapConfigFileReader \$this */
    class_exists(Oxidio\Bootstrap::class) && Oxidio\Bootstrap::bootstrap(\$this);
});

EOF
    [[ -z ${DB_STATE} ]] || chmod 444 "$base"/source/config.inc.php
    [[ -z ${DB_STATE} ]] || rm -rf "$base/source/Setup"

    local shop=${SHOP_URL##http*/}
    local theme=${SHOP_THEME:-flow}
    local rShared=${SHOP_RESOURCES_SHARED:-resources/shared}
    local rLocal=${SHOP_RESOURCES_LOCAL:-resources/local}
    local rTheme=${SHOP_RESOURCES_THEME:-resources/shared/theme}

    echo -e "\e[92mcreate links: \e[44m shared assets \e[0m"
    publicLinks \
        "$rShared"/downloads:out/downloads \
        "$rShared"/pictures/master:out/pictures/master \
        "$rShared"/pictures/media:out/pictures/media \
        "$rShared"/pictures/promo:out/pictures/promo \
        "$rShared"/pictures/vendor:out/pictures/vendor

    echo -e "\e[92mcreate links: \e[44m local assets \e[0m"
    publicLinks \
        "$rLocal"/cache-data:tmp \
        "$rLocal"/cache-img:out/pictures/generated \
        "$rLocal"/log:log

    echo -e "\e[92mcreate links: \e[44m local '$shop' assets \e[0m"
    publicLinks \
        "$rLocal"/"$shop"/cache-data:tmp \
        "$rLocal"/"$shop"/cache-img:out/pictures/generated \
        "$rLocal"/"$shop"/log:log

    echo -e "\e[92mcreate links: \e[44m theme '$theme' assets \e[0m"
    publicLinks \
        "$rTheme"/bg:out/"$theme"/bg \
        "$rTheme"/css:out/"$theme"/src/css \
        "$rTheme"/fonts:out/"$theme"/src/fonts \
        "$rTheme"/img:out/"$theme"/img \
        "$rTheme"/js:out/"$theme"/src/js \
        "$rTheme"/theme.jpg:out/"$theme"/theme.jpg

    return 0;
}

function publicLinks() {
    local line dst link rel base=${PWD}
    for line in "$@"; do
        link=$(echo "$line"| cut -d: -f 1)
        dst=$(echo "$line"| cut -d: -f 2)
        if [[ -e ${base}/${link} ]]; then
            rel=${dst//[^\/]}
            rel=$(printf '../%.0s' $(seq 0 ${#rel}))
            mkdir -p "$base/source/$dst" 2>/dev/null
            rm -rf "$base/source/$dst"
            ln -sf "$rel$link" "$base/source/$dst"
            echo "$base/source/$dst  ->  $rel$link"
        fi
    done
}

main "$@"
